<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vova & Petrova</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="logo">Vova & Petrova</h1>
      <nav class="nav" id="main-nav"></nav>
    </header>
    
    <main class="main">
      <div id="breadcrumbs"></div>
      <!-- Контент страницы будет рендериться роутером -->
    </main>

    <footer class="footer">
      <p>Генерируется из vovaipetrova-core</p>
    </footer>
  </div>

  <script src="./core/router.js"></script>
  <script src="./core/navigation.js"></script>
  <script>
    // Данные из build
    const routes = {{ROUTES}};
    const tokens = {{TOKENS}};

    // Применяем токены как CSS переменные
    if (tokens && tokens.colors) {
      const root = document.documentElement;
      const colors = tokens.colors;
      
      if (colors.background) {
        root.style.setProperty('--bg-primary', colors.background.primary || '#f6f7fb');
        root.style.setProperty('--bg-card', colors.background.card || '#ffffff');
      }
      if (colors.text) {
        root.style.setProperty('--text-primary', colors.text.primary || '#1f2933');
        root.style.setProperty('--text-muted', colors.text.muted || '#64748b');
      }
      if (colors.status) {
        root.style.setProperty('--status-ready', colors.status.ready || '#0f9960');
        root.style.setProperty('--status-review', colors.status.review || '#d9822b');
        root.style.setProperty('--status-draft', colors.status.draft || '#7b8794');
      }
    }

    // Инициализация роутера и навигации
    let router, navigation;

    function initApp() {
      if (!routes || !routes.routes) {
        console.error('Routes data not found');
        return;
      }

      // Создаём компоненты
      router = new Router(routes);
      navigation = new Navigation(routes);

      // Рендерим навигацию
      navigation.renderMainNav('main-nav');
      
      // Обновляем навигацию при смене маршрута
      window.addEventListener('hashchange', () => {
        navigation.renderMainNav('main-nav');
        const currentRoute = window.location.hash.slice(1) || '/';
        navigation.renderBreadcrumbs('breadcrumbs', currentRoute);
      });

      // Рендерим breadcrumbs для текущего маршрута
      const currentRoute = window.location.hash.slice(1) || '/';
      navigation.renderBreadcrumbs('breadcrumbs', currentRoute);
    }

    // Загрузка KB glossary (вызывается только на странице /kb)
    async function loadKB() {
      const kbList = document.getElementById('kb-list');
      if (!kbList) return; // Элемент может отсутствовать на некоторых страницах
      try {
        const response = await fetch('./data/kb_glossary_lite.jsonl');
        if (!response.ok) {
          kbList.innerHTML = '<p class="error">KB glossary не найден</p>';
          return;
        }
        const text = await response.text();
        const lines = text.trim().split('\n').filter(Boolean);
        const items = lines.slice(0, 10).map(line => {
          const item = JSON.parse(line);
          return `<div class="kb-item">
            <h4>${item.title}</h4>
            <p>${item.lite_summary || ''}</p>
          </div>`;
        }).join('');

        kbList.innerHTML = items || '<p>Термины не найдены</p>';
      } catch (error) {
        kbList.innerHTML = '<p class="error">Ошибка загрузки KB</p>';
      }
    }

    // Загрузка Stories (вызывается только на странице /stories)
    async function loadStories() {
      const storiesList = document.getElementById('stories-list');
      if (!storiesList) return; // Элемент может отсутствовать на некоторых страницах
      try {
        const response = await fetch('./data/stories_digests.jsonl');
        if (!response.ok) {
          storiesList.innerHTML = '<p class="error">Stories digests не найдены</p>';
          return;
        }
        const text = await response.text();
        const lines = text.trim().split('\n').filter(Boolean);
        const items = lines.slice(0, 5).map(line => {
          const item = JSON.parse(line);
          return `<div class="story-item">
            <h4>${item.title}</h4>
            <p>Эпизодов: ${item.episodes ? item.episodes.length : 0}</p>
          </div>`;
        }).join('');

        storiesList.innerHTML = items || '<p>Stories не найдены</p>';
      } catch (error) {
        storiesList.innerHTML = '<p class="error">Ошибка загрузки Stories</p>';
      }
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
      initApp();
      // Загружаем данные для страниц, которые их используют
      loadKB();
      loadStories();
    });
  </script>
</body>
</html>
